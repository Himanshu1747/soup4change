---
import HeaderLink from "./HeaderLink.astro";
import { queryWordPress } from "../lib/wordpress";

const QUERY_MENU = `
query MainMenu {
  menu(id: "mainmenu", idType: SLUG) {
    menuItems(first: 100) { 
      nodes {
        id
        label
        uri
        target
        parentId
        order
        childItems {
          nodes {
            id
            label
            uri
            order
          }
        }
      }
    }
  }
  siteLogo {
    sourceUrl
    altText
  }
}
`;

const data = await queryWordPress(QUERY_MENU);
const logo = data?.siteLogo;
const rawNodes = data?.menu?.menuItems?.nodes || [];

const menuItems = rawNodes
	.filter((item) => !item.parentId)
	.sort((a, b) => (a.order || 0) - (b.order || 0))
	.map((item) => ({
		...item,
		children:
			item.childItems?.nodes?.sort(
				(a, b) => (a.order || 0) - (b.order || 0),
			) || [],
	}));
---

{logo && (
  <link 
    rel="preload" 
    as="image" 
    href={logo.sourceUrl} 
    fetchpriority="high" 
  />
)}

<header class="custom-header">
	<div class="container">
		<div class="grid-headers">
			<div class="grid-mobiles">
				<div class="main_logo">
					<a href="/" title="Soup4change">
						{
							logo && (
								<img
									src={logo.sourceUrl}
									alt={logo.altText || "Logo"}
									width="166"
									height="94"
									loading="eager"
									decoding="sync"
								/>
							)
						}
					</a>
				</div>
				<div class="menu-icon">
					<svg
						class="bars"
						viewBox="0 0 100 100"
						onclick="this.classList.toggle('active')"
					>
						<path
							class="line top"
							d="m 30,33 h 40 c 13.100415,0 14.380204,31.80258 6.899646,33.421777 -24.612039,5.327373 9.016154,-52.337577 -12.75751,-30.563913 l -28.284272,28.284272"
						></path>
						<path
							class="line middle"
							d="m 70,50 c 0,0 -32.213436,0 -40,0 -7.786564,0 -6.428571,-4.640244 -6.428571,-8.571429 0,-5.895471 6.073743,-11.783399 12.286435,-5.570707 6.212692,6.212692 28.284272,28.284272 28.284272,28.284272"
						></path>
						<path
							class="line bottom"
							d="m 69.575405,67.073826 h -40 c -13.100415,0 -14.380204,-31.80258 -6.899646,-33.421777 24.612039,-5.327373 -9.016154,52.337577 12.75751,30.563913 l 28.284272,-28.284272"
						></path>
					</svg>
				</div>
			</div>

			<div class="header-linksgrids">
				<ul class="list_data">
					{
						menuItems.map((item) => (
							<li
								class={
									item.children.length
										? "menu-item-has-children"
										: ""
								}
							>
								<HeaderLink
									href={item.uri}
									title={item.label}
									target={item.target}
								>
									{item.label}
								</HeaderLink>

								{item.children.length > 0 && (
									<ul class="sub-menu">
										{item.children.map((child) => (
											<li>
												<HeaderLink
													href={child.uri}
													title={child.label}
												>
													{child.label}
												</HeaderLink>
											</li>
										))}
									</ul>
								)}
							</li>
						))
					}
				</ul>
			</div>
		</div>
	</div>
</header>
<div class="margin-top"></div>


<style>
	header.custom-header {
		background: rgba(255, 255, 255, 0.6);
		backdrop-filter: blur(2px);
		position: fixed;
		top: 0;
		width: 100%;
		z-index: 11;
		padding: 5px 0px;
		transition:
			background 0.3s ease-in-out,
			backdrop-filter 0.3s ease-in-out;
	}

	header.custom-header.activeheader ul.sub-menu li{
		background: var(--color-white);
	}

	header.custom-header.activeheader {
		background: var(--color-white);
		backdrop-filter: blur(0px);
		box-shadow: rgba(99, 99, 99, 0.2) 0px 2px 8px 0px;
	}
	.grid-headers,
	ul.list_data,
	.header-linksgrids {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 30px;
	}

	.menu-icon {
		display: none;
	}
	ul.list_data li a,
	ul.list_data li:last-child a {
		color: var(--color-blue);
		font-size: 18px;
		font-style: normal;
		font-weight: 700;
		line-height: normal;
	}

	header.custom-header .header-linksgrids ul.list_data li:last-child a {
		color: var(--color-white) !important;
	}

	header.custom-header
		.header-linksgrids
		ul.list_data
		li
		ul.sub-menu
		li:last-child
		a {
		color: var(--color-blue) !important;
	}

	header.custom-header
		.header-linksgrids
		ul.list_data
		li
		ul.sub-menu
		li:last-child
		a:hover {
		color: var(--color-red) !important;
	}

	ul.list_data li ul.sub-menu li a {
		background: initial !important;
		padding: initial !important;
		color: var(--color-blue) !important;
	}

	ul.list_data li ul.sub-menu li a:hover {
		color: var(--color-red) !important;
	}

	.header-linksgrids ul.list_data li a.active,
	.header-linksgrids ul.list_data li ul.sub-menu li a.active {
		color: var(--color-red) !important;
	}

	header.custom-header
		.container
		.header-linksgrids
		ul.list_data
		ul.sub-menu
		li
		a.active {
		color: var(--color-red) !important;
	}

	ul.list_data li a:hover {
		color: var(--color-red);
	}

	ul.list_data li:last-child a {
		display: inline-block;
		border-radius: 10px;
		background: var(--color-blue);
		color: var(--color-white) !important;
		padding: 13px 28px;
		transition: 0.3s ease-in;
	}

	ul.sub-menu li a {
		text-transform: capitalize;
	}
	ul.list_data li:last-child a:hover {
		background: var(--color-red);
	}
	.main_logo {
		max-width: 166px;
		width: 100%;
	}

	li.menu-item-has-children {
		position: relative;
	}

	ul.sub-menu {
		position: absolute;
		width: 220px;
		padding-top: 39px;
		display: none;
	}

	li.menu-item-has-children ul.sub-menu li {
		background: rgba(217, 217, 217, 0.8);
		backdrop-filter: blur(5px);
		padding: 0px 20px 15px 20px;
	}
	li.menu-item-has-children ul.sub-menu li:first-child {
		padding: 20px;
	}

	.bars {
		width: 60px;
		cursor: pointer;
	}

	.bars .line {
		fill: none;
		stroke: #000;
		stroke-width: 4;
		stroke-linecap: square;
		transition:
			stroke-dasharray 400ms,
			stroke-dashoffset 1s;
	}

	.bars .line.top {
		stroke-dasharray: 40 172;
	}

	.bars .line.middle {
		stroke-dasharray: 40 111;
	}

	.bars .line.bottom {
		stroke-dasharray: 40 172;
	}

	.bars.active .top {
		stroke-dashoffset: -132px;
	}

	.bars.active .middle {
		stroke-dashoffset: -71px;
	}

	.bars.active .bottom {
		stroke-dashoffset: -132px;
	}

	/* MENU ICON ANIMATED END */

	.margin-top {
		display: none;
	}

	@media (min-width: 1200px) {
		li.menu-item-has-children:hover ul.sub-menu {
			display: block !important;
		}
	}

	@media (max-width: 1600px) {
		ul.list_data li a,
		ul.list_data li:last-child a {
			font-size: 18px;
		}

		ul.list_data li:last-child a {
			padding: 12px 20px;
		}

		.grid-headers,
		ul.list_data,
		.header-linksgrids {
			gap: 20px;
		}
	}

	@media (max-width: 1399px) {
		ul.list_data li a,
		ul.list_data li:last-child a {
			font-size: 16px;
		}
		.main_logo {
			max-width: 120px;
		}

		ul.list_data li:last-child a {
			padding: 10px 15px;
		}

		ul.sub-menu {
			padding-top: 27px;
		}
	}

	@media (max-width: 1199px) {
		.grid-headers {
			flex-direction: column;
			align-items: start;
			gap: 10px;
		}
		.header-linksgrids,
		ul.list_data {
			flex-direction: column;
			align-items: start;
			gap: 10px;
			width: 100%;
		}
		ul.sub-menu {
			position: static;
			width: 100%;
			padding: 10px 0px;
		}
		li.menu-item-has-children ul.sub-menu li,
		li.menu-item-has-children ul.sub-menu li:first-child {
			padding: 5px 10px;
		}

		li.menu-item-has-children {
			width: 100%;
		}
		li.menu-item-has-children::after {
			position: absolute;
			top: 5px;
			right: 10px;
			width: 12px;
			height: 12px;
			border-right: 2px solid var(--color-black);
			border-bottom: 2px solid var(--color-black);
			transform: translateY(-50%) rotate(45deg);
			content: "";
			transition: 0.3s ease-in;
		}

		.menu-icon {
			display: block;
		}
		.grid-mobiles {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
		}
		.connected-here {
			padding: 20px 0px;
		}
		.header-linksgrids {
			display: none;
			padding: 20px 0px 40px 0px;
		}
		header.custom-header {
			background: #fff;
		}
		.margin-top {
			display: block;
			margin-top: 77px;
		}
	}
	@media (max-width: 767px) {
		.bars {
			width: 50px;
		}
	}
</style>

<script is:inline>
  let lastKnownScrollPosition = 0;
  let ticking = false;

  function updateHeader(scrollPos) {
    const header = document.querySelector(".custom-header");
    if (scrollPos > 50) {
      header.classList.add("activeheader");
    } else {
      header.classList.remove("activeheader");
    }
  }

  // PASSIVE listener does not block scrolling
  window.addEventListener("scroll", () => {
    lastKnownScrollPosition = window.scrollY;
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateHeader(lastKnownScrollPosition);
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });


  
document.addEventListener("DOMContentLoaded", function () {
    $(".menu-icon").click(function () {
      $(".header-linksgrids").slideToggle();
    });

    $(".sub-menu").hide();
    $(".menu-item-has-children").click(function (e) {
      e.stopPropagation();
      $(this).children(".sub-menu").slideToggle();
    });
  });


</script>
